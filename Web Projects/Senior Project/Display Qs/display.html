<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> Q Display</title>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <!-- Stylesheet -->
    <link rel="stylesheet" href="display style.css" />
</head>
<body>
    <div id="display-container" class="quiz-container">
        <div class="header">
            <div class="timer-div">
                <img src="timer-icon.svg" />
                <span class="time-left">10s</span>
            </div>
        </div>
        <div id="container" class="quiz-container">
            <!-- questions and options will be displayed here -->
        </div>
        <button id="next-button">Finish editing</button>
    </div>
    <div class="score-container hide">
        <div id="user-score">Demo Score</div>
        <button id="restart">Restart</button>
    </div>
    
    <!-- Script -->
    <script>
        // Retrieve questions from local storage
        const displayQuestions = JSON.parse(localStorage.getItem('displayQuestions'));
    
        // Quiz Creation
        function quizCreator(quizArray) {
            // Code for quiz creation based on quizArray
            let quizContainer = document.getElementById("container");
            for (let i of quizArray) {
                // Randomly sort options
                i.options.sort(() => Math.random() - 0.5);
                // Question
                let questionContainer = document.createElement("div");
                questionContainer.classList.add("question-container");
    
                let question_DIV = document.createElement("p");
                question_DIV.classList.add("question");
                question_DIV.innerHTML = `<span contentEditable="true">${i.questionText}</span>`;
                questionContainer.appendChild(question_DIV);
    
                // Options
                for (let option of i.options) {
                    let optionButton = document.createElement("button");
                    optionButton.classList.add("option-div");
                    optionButton.innerHTML = `<span contentEditable="true">${option}</span>`;
                    questionContainer.appendChild(optionButton);
                }
    
                quizContainer.appendChild(questionContainer);
            }
            quizContainer.classList.remove("hide");
        }
    
        // Call quizCreator function with displayQuestions
        quizCreator(displayQuestions);
    
        document.addEventListener("DOMContentLoaded", function () {
            const finishEditingBtn = document.getElementById('next-button');
    
            finishEditingBtn.addEventListener('click', async function () {
                // Update the questions array with the edited content
                updateQuestionsArray();
    
                // Update the complete exam data with new questions
                const completeExamData = {
                    examName: localStorage.getItem('examName'),
                    course: localStorage.getItem('course'),
                    allottedTime: localStorage.getItem('allottedTime'),
                    questions: displayQuestions
                };
    
                // Save the updated complete exam data to local storage
                localStorage.setItem('completeExamData', JSON.stringify(completeExamData));
    
                // Sending the complete exam data to the server endpoint '/addExam'
                try {
                    const response = await fetch('http://localhost:3000/addExam', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(completeExamData)
                    });
    
                    const data = await response.json();
                    if (data.success) {
                        console.log('Exam added successfully:', data.exam);
                        // Redirect after successful exam addition
                        window.location.href = "../Dashboards/teacher-dashboard.html";
                    } else {
                        console.error('Error adding exam:', data.message);
                    }
                } catch (error) {
                    console.error('Error in finishEditingBtn click:', error);
                }
            });
    
            function updateQuestionsArray() {
                // Iterate through the displayed questions and update the array
                const questionContainers = document.querySelectorAll('.question-container');
                questionContainers.forEach((container, index) => {
                    const questionText = container.querySelector('.question span').textContent;
                    const options = Array.from(container.querySelectorAll('.option-div span')).map(span => span.textContent);
                    displayQuestions[index].questionText = questionText;
                    displayQuestions[index].options = options;
                });
            }
        });
    </script>
</body>
</html>
